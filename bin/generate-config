#!/bin/bash

# PHPCS Common Rules Configuration Generator
# Generates phpcs-common.xml with security rules and common exclusions

set -e

PROJECT_ROOT="$(pwd)"
CONFIG_FILE="$PROJECT_ROOT/phpcs-common.xml"

echo "ðŸ”§ Generating PHPCS Common Rules configuration..."

# Create the phpcs-common.xml file
cat > "$CONFIG_FILE" << 'EOF'
<?xml version="1.0"?>
<ruleset name="Common Security Standards">
    <description>Common security standards and coding rules</description>
    
    <!-- Include security rules -->
    <rule ref="CommonSecurity"/>
    
    <!-- Scan current directory -->
    <file>.</file>
    
    <!-- Common exclusions -->
    <exclude-pattern>*/vendor/*</exclude-pattern>
    <exclude-pattern>*/node_modules/*</exclude-pattern>
    <exclude-pattern>*/build/*</exclude-pattern>
    <exclude-pattern>*/dist/*</exclude-pattern>
    <exclude-pattern>*/.git/*</exclude-pattern>
    
    <!-- WordPress specific exclusions (if applicable) -->
    <exclude-pattern>*/wp-content/uploads/*</exclude-pattern>
    <exclude-pattern>*/wp-includes/*</exclude-pattern>
    <exclude-pattern>*/wp-admin/*</exclude-pattern>
    
    <!-- Show progress and use colors -->
    <arg name="colors"/>
    <arg value="p"/>
    
    <!-- Use PSR-12 as base standard -->
    <rule ref="PSR12"/>
    
    <!-- Security-focused rules -->
    <rule ref="Generic.PHP.ForbiddenFunctions">
        <properties>
            <property name="forbiddenFunctions" type="array">
                <element key="eval" value="null"/>
                <element key="exec" value="null"/>
                <element key="system" value="null"/>
                <element key="shell_exec" value="null"/>
                <element key="passthru" value="null"/>
                <element key="file_get_contents" value="null"/>
                <element key="file_put_contents" value="null"/>
                <element key="fopen" value="null"/>
                <element key="fwrite" value="null"/>
                <element key="phpinfo" value="null"/>
            </property>
        </properties>
    </rule>
</ruleset>
EOF

echo "âœ… Generated: $CONFIG_FILE"
echo ""
echo "ðŸ“‹ Usage:"
echo "  vendor/bin/phpcs --standard=phpcs-common.xml"
echo "  vendor/bin/phpcs -p --colors --standard=phpcs-common.xml ."
echo ""
echo "ðŸ’¡ Tip: Add 'phpcs-common.xml' to your .gitignore if you want to keep it local"
